---
title: "Data_Vis"
author: "Rachael E. Blake"
date: "May 1, 2017"
output:
  pdf_document: default
  html_document: default
---

```{r, include=FALSE, echo=FALSE, results='hide'}
library(ggplot2) ; library(tidyverse)

```

```{r, echo=FALSE, include=FALSE}
# PDO data
source("PDO_cleaning.r")

# dataframes are pdo_mon and pdo_ann

pdo_mon_adj <- pdo_mon %>%
               mutate(Month_number = forcats::fct_recode(Month, "01"="JAN", "02"="FEB", "03"="MAR",
                                                                "04"="APR", "05"="MAY", "06"="JUN", 
                                                                "07"="JUL", "08"="AUG", "09"="SEP", 
                                                                "10"="OCT", "11"="NOV", "12"="DEC"),
                      Yr_Mn = paste(Year, Month_number, sep="-"),
                      Sign = ifelse(PDO>0, "A", "B"))
               
```

```{r, echo=FALSE}
# PDO plots
pdo_plot <- ggplot(data=pdo_mon, aes(x=Year, y=PDO)) + geom_col() + 
            geom_hline(yintercept=0, size=1.5) + ylab("PDO Index")

  
#
pdo_plot2 <- ggplot(data=pdo_mon_adj, aes(x=Yr_Mn, y=PDO)) + 
             geom_col(aes(fill=Sign)) + xlab("Year") +            #, show.legend=FALSE
             geom_hline(yintercept=0, size=1) + ylab("PDO Index") + 
             scale_x_discrete(breaks=c("1998-01","1999-01", "2000-01", "2001-01", "2002-01", "2003-01",
                                       "2004-01", "2005-01", "2006-01", "2007-01", "2008-01", "2009-01", 
                                       "2010-01", "2011-01", "2012-01", "2013-01", "2014-01", "2015-01", 
                                       "2016-01"),
                              labels=c("1998", "1999", "2000", "2001", "2002", "2003", "2004", "2005",
                                       "2006", "2007", "2008", "2009", "2010", "2011", "2012", "2013",
                                       "2014","2015", "2016"))

```

```{r, echo=FALSE, include=FALSE}
# Freshwater Discharge Hill Model data
source("Fresh_Discharge_cleaning.r")

# dataframes are FWD_ann_mn and FWD_mon_mn

```

```{r, echo=FALSE}
fwd_plot <- ggplot(data=FWD_ann_mn, aes(x=Year, y=(mean_yearly_anomaly*10))) + 
            geom_col(aes(fill=Sign)) + ylab("Yearly Anomaly") + theme_bw() +
            geom_hline(yintercept=0, size=1) + 
            scale_fill_manual(values=c("A"="#f88379", "B"="#00BFC4"),
                              name="",
                              labels=c("positive runoff", "negative runoff")) 
 
  

FWD_mon_mn$Year_Month2 <- factor(FWD_mon_mn$Year_Month, 
                                 levels=c("1999.01", "1999.02", "1999.03", "1999.04", "1999.05", "1999.06",
                                          "1999.07", "1999.08", "1999.09", "1999.10", "1999.11", "1999.12",
                                          "2000.01", "2000.02", "2000.03", "2000.04", "2000.05", "2000.06",
                                          "2000.07", "2000.08", "2000.09", "2000.10", "2000.11", "2000.12",
                                          "2001.01", "2001.02", "2001.03", "2001.04", "2001.05", "2001.06",
                                          "2001.07", "2001.08", "2001.09", "2001.10", "2001.11", "2001.12",
                                          "2002.01", "2002.02", "2002.03", "2002.04", "2002.05", "2002.06", 
                                          "2002.07", "2002.08", "2002.09", "2002.10", "2002.11", "2002.12",
                                          "2003.01", "2003.02", "2003.03", "2003.04", "2003.05", "2003.06",
                                          "2003.07", "2003.08", "2003.09", "2003.10", "2003.11", "2003.12",
                                          "2004.01", "2004.02", "2004.03", "2004.04", "2004.05", "2004.06",
                                          "2004.07", "2004.08", "2004.09", "2004.10", "2004.11", "2004.12",
                                          "2005.01", "2005.02", "2005.03", "2005.04", "2005.05", "2005.06",
                                          "2005.07", "2005.08", "2005.09", "2005.10", "2005.11", "2005.12",
                                          "2006.01", "2006.02", "2006.03", "2006.04", "2006.05", "2006.06",
                                          "2006.07", "2006.08", "2006.09", "2006.10", "2006.11", "2006.12", 
                                          "2007.01", "2007.02", "2007.03", "2007.04", "2007.05", "2007.06", 
                                          "2007.07", "2007.08", "2007.09", "2007.10", "2007.11", "2007.12", 
                                          "2008.01", "2008.02", "2008.03", "2008.04", "2008.05", "2008.06",
                                          "2008.07", "2008.08", "2008.09", "2008.10", "2008.11", "2008.12",
                                          "2009.01", "2009.02", "2009.03", "2009.04", "2009.05", "2009.06",
                                          "2009.07", "2009.08", "2009.09", "2009.10", "2009.11", "2009.12",
                                          "2010.01", "2010.02", "2010.03", "2010.04", "2010.05", "2010.06", 
                                          "2010.07", "2010.08", "2010.09", "2010.10", "2010.11", "2010.12", 
                                          "2011.01", "2011.02", "2011.03", "2011.04", "2011.05", "2011.06", 
                                          "2011.07", "2011.08", "2011.09", "2011.10", "2011.11", "2011.12", 
                                          "2012.01", "2012.02", "2012.03", "2012.04", "2012.05", "2012.06", 
                                          "2012.07", "2012.08", "2012.09", "2012.10", "2012.11", "2012.12",
                                          "2013.01", "2013.02", "2013.03", "2013.04", "2013.05", "2013.06", 
                                          "2013.07", "2013.08", "2013.09", "2013.10", "2013.11", "2013.12", 
                                          "2014.01", "2014.02", "2014.03", "2014.04", "2014.05", "2014.06", 
                                          "2014.07", "2014.08"))
fwd_plot2 <- ggplot(data=FWD_mon_mn, aes(x=Year_Month2, y=mean_monthly_anomaly)) + 
             geom_col(aes(fill=Sign)) + theme_bw() + 
             geom_hline(yintercept=0, size=1) +  
             scale_x_discrete(breaks=c("1998.01", "1999.01", "2000.01", "2001.01", "2002.01", "2003.01",
                                       "2004.01", "2005.01", "2006.01", "2007.01", "2008.01", 
                                       "2009.01", "2010.01", "2011.01", "2012.01", "2013.01", 
                                       "2014.01", "2015.01", "2016.01"),
                              labels=c("1998", "1999", "2000", "2001", "2002", "2003", "2004", "2005",
                                       "2006", "2007", "2008", "2009", "2010", "2011", "2012", "2013",
                                       "2014","2015", "2016"),
                              limits=c(levels(FWD_mon_mn$Year_Month2))
                              ) +
             scale_fill_manual(values=c("A"="#f88379", "B"="#00BFC4"),
                               name="",
                               labels=c("positive runoff", "negative runoff")) 
 
  

```


#Invertebrates: Percent Cover Data
```{r, include=FALSE, echo=FALSE, results='hide'}
# source the data cleaning script
source("Data_Cleaning_K_Bay.r")

# dataframe is called PerCov_clean

PerCov_long <- PerCov_clean %>%
               gather(Taxa, Percent_Cover, -standard_code, -plot, -abbr_code, -Year, -Block, -Treatment)

PerCov_anom <- PerCov_long %>%
               dplyr::select(-standard_code, -abbr_code) %>%
               dplyr::filter(Treatment == "01") %>%
               dplyr::group_by(Taxa) %>%
               dplyr::mutate(Taxa_Mean = mean(Percent_Cover),
                             PerCov_Anom = Percent_Cover-Taxa_Mean) %>%
               dplyr::ungroup() %>%
               dplyr::group_by(Taxa, Year) %>%
               dplyr::mutate(Year_Mean = mean(Percent_Cover),
                             Year_Anom = mean(Year_Mean-Taxa_Mean),
                             Year_Anom_Scale = Year_Anom/100) %>%
               dplyr::ungroup() %>%
               dplyr::arrange(Year, Block, Treatment, Taxa)

```

```{r, echo=FALSE}
explore_plots <- function(y_var){
                 p <- ggplot(data=PerCov_clean, aes_string(x="Year", y=y_var, fill="Treatment")) + 
                      geom_boxplot() + theme(legend.position="top", legend.title=element_blank()) +
                      scale_fill_manual(breaks=c("01","99","00","10"),
                                        labels=c("Control","Treatment 1","Treatment 2","10"),
                                        values=c("#086d44","#2d348f","#fc7307","#a8148b"))
                 return(p)
}


```

```{r, echo=FALSE, fig.height=3.5, fig.width=7}
# Fucus Total
# ft <- explore_plots("FUCUS_TOTAL")
# ft

# make a plot for each variable
var_names <- names(PerCov_clean[,c(4:28)]) 

lapply(var_names, function(x) FUN=explore_plots(y_var=x))

```

```{r, echo=FALSE, eval=FALSE}
# Mussel anomaly plot
anom_muss <- ggplot(data=PerCov_anom[PerCov_anom$Taxa == "Mytilus",]) + 
             geom_col(aes(x=Year,y=Year_Anom_Scale))

# Fucus anomaly plot
anom_fucu <- ggplot(data=PerCov_anom[PerCov_anom$Taxa == "FUCUS_TOTAL",]) + 
             geom_col(aes(x=Year,y=Year_Anom_Scale))

```

```{r, echo=FALSE, fig.height=5, fig.width=8}
# combined PDO and mussel anomaly plot
anom_pdo_muss <- pdo_plot2 + 
                 geom_col(data=PerCov_anom[PerCov_anom$Taxa == "Mytilus",], 
                          aes(x=Year,y=Year_Anom_Scale, color="#696366"), width=2) +    #show.legend=TRUE   
                 ylab("Anomaly") + theme_bw() + ylim(-4,4) +
                 scale_fill_manual(values=c("A"="#f88379", "B"="#00BFC4"),
                                   name="",
                                   labels=c("positive PDO", "negative PDO")) +
                 scale_color_manual(values="#595959", name="", labels="Mytilus % cover") + 
                 theme(panel.grid.major=element_blank(),
                       panel.grid.minor=element_blank(),
                       panel.border=element_blank(),
                       legend.position=c(.92, .15),
                       legend.margin=margin(t=-0.8, unit="cm"),
                       axis.text = element_text(size=10),
                       axis.title = element_text(size=16),
                       axis.line = element_line(colour='black', size=0.5, linetype='solid'))
anom_pdo_muss

# combined PDO and Fucus anomaly plot
anom_pdo_fucu <- pdo_plot2 + 
                 geom_col(data=PerCov_anom[PerCov_anom$Taxa == "FUCUS_TOTAL",], 
                          aes(x=Year,y=Year_Anom_Scale, color="#696366"), width=2) + 
                 ylab("Anomaly") + theme_bw() + ylim(-4,4) +
                 scale_fill_manual(values=c("A"="#f88379", "B"="#00BFC4"),
                                   name="",
                                   labels=c("positive PDO", "negative PDO")) +
                 scale_color_manual(values="#595959", labels="Fucus % cover") + 
                 theme(panel.grid.major=element_blank(),
                       panel.grid.minor=element_blank(),
                       panel.border=element_blank(),
                       legend.position=c(.92, .15),
                       legend.margin=margin(t=-0.8, unit="cm"),
                       axis.text = element_text(size=10),
                       axis.title = element_text(size=16),
                       axis.line = element_line(colour = 'black', size=0.5, linetype='solid'))
anom_pdo_fucu

# combined PDO and Barnacles anomaly plot
anom_pdo_barn <- pdo_plot2 + 
                 geom_col(data=PerCov_anom[PerCov_anom$Taxa == "Barnacles",], 
                          aes(x=Year,y=Year_Anom_Scale, color="#696366"), width=2) + 
                 ylab("Anomaly") + theme_bw() + ylim(-4,4) +
                 scale_fill_manual(values=c("A"="#f88379", "B"="#00BFC4"),
                                   name="",
                                   labels=c("positive PDO", "negative PDO")) +
                 scale_color_manual(values="#595959", labels="Barnacle % cover") + 
                 theme(panel.grid.major=element_blank(),
                       panel.grid.minor=element_blank(),
                       panel.border=element_blank(),
                       legend.position=c(.92, .15),
                       legend.margin=margin(t=-0.8, unit="cm"),
                       axis.text = element_text(size=10),
                       axis.title = element_text(size=16),
                       axis.line = element_line(colour = 'black', size=0.5, linetype='solid'))
anom_pdo_barn


```

```{r, echo=FALSE, fig.height=5, fig.width=8}
# combined freshwater discharge and invert plots
fwdplot_myt <- fwd_plot2 + 
               geom_col(data=PerCov_anom[PerCov_anom$Taxa == "Mytilus",], 
                        aes(x=Year, y=Year_Anom_Scale, color="#595959"), width=.1) +    #show.legend=TRUE   
               ylab("Anomaly") + theme_bw() + ylim(-0.45,0.45) + 
               scale_color_manual(values="#595959", name="", labels="Mytilus % cover") +
               theme(panel.grid.major=element_blank(),
                       panel.grid.minor=element_blank(),
                       panel.border=element_blank(),
                       legend.position=c(.22, .15),
                       legend.margin=margin(t=-0.8, unit="cm"),
                       axis.text = element_text(size=10),
                       axis.title = element_text(size=16),
                       axis.line = element_line(colour = 'black', size=0.5, linetype='solid'))
fwdplot_myt



```



# NMDS Plots
```{r, echo=FALSE, include=FALSE}
source("NMDS_analysis.r")

# need to use NMDS output percov_mds$points

```

```{r, echo=FALSE, fig.height=6, fig.width=8}
# prettier plotting
# build a data frame with NMDS coordinates and metadata
NMDS_ord <- data.frame(MDS1 = percov_mds$points[,1], MDS2 = percov_mds$points[,2],
                       PDO_Sign = PerCov_PDO$PDO_Sign, Year = PerCov_PDO$Year)

# now the plot
ord1 <- ggplot(NMDS_ord, aes(x=MDS1, y=MDS2, color=PDO_Sign)) +
        geom_point() + stat_ellipse() +
        theme_bw() + #labs(title = "NMDS Plot by PDO") + 
        scale_color_manual(values=c("A"="#f88379", "B"="#00BFC4"), name="",
                           labels=c("positive PDO","negative PDO")) + 
        theme(panel.grid.major=element_blank(),
              panel.grid.minor=element_blank())
ord1

ord2 <- ggplot(NMDS_ord, aes(x=MDS1, y=MDS2, color=Year)) +
        geom_point() + #stat_ellipse() +
        theme_bw() + labs(title = "NMDS Plot by Year")


```

```{r, echo=FALSE}
percov_perm
```



